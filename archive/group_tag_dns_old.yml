# Group vars for CoreDNS nodes running etcd cluster

#
# linux-system-roles.storage vars
#
# After increasing the VM disk size in Proxmox/Terraform, rerun playbook
storage_pools:
  - name: vg_etcd
    disks:
      - sdb
    type: lvm
    grow_to_fill: true
    volumes:
      - name: lv_etcd
        size: "100%"
        fs_type: ext4
        mount_point: "/var/lib/etcd"
        mount_options: "defaults,noatime"
        mount_user: "etcd"
        mount_group: "etcd"
        mount_mode: "0700"
        state: present

#
# igor_nikiforov.etcd vars
#
etcd_version: "3.6.6"
etcd_config:
  name: "{{ inventory_hostname }}"
  data-dir: "/var/lib/etcd/data"
  wal-dir: "/var/lib/etcd/wal"

  # Self-signed certs generated by etcd
  client-transport-security:
    auto-tls: true
  peer-transport-security:
    auto-tls: true

  initial-advertise-peer-urls: "https://{{ ansible_default_ipv4.address }}:2380"
  listen-peer-urls: "https://{{ ansible_default_ipv4.address }}:2380"
  # CoreDNS etcd plugin does not support skipping TLS verification; use local HTTP for CoreDNS.
  advertise-client-urls: "https://{{ ansible_default_ipv4.address }}:2379,http://127.0.0.1:2379"
  listen-client-urls: "https://{{ ansible_default_ipv4.address }}:2379,https://127.0.0.1:2379,http://127.0.0.1:2379"

  initial-cluster-token: "coredns"
  # Use "new" only for the very first bootstrap, then switch to "existing"
  initial-cluster-state: "existing"

  # Static bootstrap list ("name=peerURL,name2=peerURL2,...")
  initial-cluster: >-
    {%- set hosts = (groups['group_tag_dns'] | default([]) | sort) -%}
    {%- set j = joiner(',') -%}
    {%- for host in hosts -%}
    {%- set peer_url = 'https://' ~ (hostvars[host].ansible_default_ipv4.address | default(hostvars[host].ansible_host | default(host))) ~ ':2380' -%}
    {{ j() }}{{ host }}={{ peer_url }}
    {%- endfor -%}

  log-level: "info"
  logger: "zap"

#
# cloudalchemy.coredns vars
#
coredns_version: "1.13.2"
coredns_dns_port: 53
coredns_config_file: "coredns/Corefile"
